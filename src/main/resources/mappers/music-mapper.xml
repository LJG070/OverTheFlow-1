<?xml version="1.0" encoding="UTF-8"  ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" " http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.studyveloper.overtheflow.mapper.MusicMapper">
	<resultMap type="MusicVO" id="music">
		<result property="id" column="music_id"/>
		<result property="title" column="music_title"/>
		<result property="playTime" column="music_play_time"/>
		<result property="registerDate" column="music_register_date"/>
		<result property="description" column="music_description"/>
		<result property="visibilityFlag" column="music_visibility_flag"/>
		<result property="downloadFlag" column="music_download_flag"/>
		<result property="playCount" column="music_play_count"/>
		<result property="categoryId" column="category_id"/>
		<result property="memberId" column="member_id"/>
		<result property="memberNickname" column="member_nickname"/>
	</resultMap>
	
	<insert id="addMusic" parameterType="MusicVO">
		INSERT INTO
			music (	music_id,
					music_title, 
					music_play_time, 
					music_description,
					music_play_count,
					category_id,
					member_id )
		VALUES
			(	#{id}, 
				#{title}, 
				#{playTime}, 
				#{description}, 
				#{playCount},
				#{categoryId}, 
				#{memberId}	);
	</insert>
	
	<update id="modifyMusic" parameterType="MusicVO">
		UPDATE 
			music
		SET
			music_title = #{title},
			music_play_time = #{playTime},
			music_description = #{description},
			music_download_flag = #{downloadFlag},
			music_visibility_flag = #{visibilityFlag},
			music_play_count = #{playCount},
			category_id = #{categoryId},
			member_id = #{memberId}
		WHERE
			music_id = #{id}
	</update>
	
	<delete id="deleteMusic" parameterType="String">
		DELETE FROM
			music
		WHERE
			music_id = #{id}
	</delete>
	
	<delete id="deleteMusics" parameterType="Map">
		DELETE FROM
			music
		<!-- 검색 -->
		<if test="searchOptions != null">
		<if test="searchOptions.size gt 0">
		<where>
			<foreach collection="searchOptions" item="searchOption" index="index" separator=" ">
				${searchOption.conjunction}
				${searchOption.columnName}
				<if test="searchOption.compareType lt 0">
				IN
					<foreach collection="searchOption.keywords" item="keyword" index="index" open="(" separator="," close=")">
						#{keyword}
					</foreach>
				</if>
				<if test="searchOption.compareType == 0">
					= #{searchOption.keyword}
				</if>
				<if test="searchOption.compareType gt 0">
					LIKE CONCAT('%', #{searchOption.keyword}, '%')
				</if>
			</foreach>
		</where>
		</if></if>
	</delete>
	
	<select id="searchMusic" parameterType="String" resultMap="music">
		SELECT * FROM 
			music_view
		WHERE
			music_id = #{id}
	</select>
	
	<select id="searchMusics" parameterType="String" resultMap="music">
		SELECT COUNT(*) FROM
			music_view
		<!-- 검색 -->
		<if test="searchOptions != null">
		<if test="searchOptions.size gt 0">
		<where>
			<foreach collection="searchOptions" item="searchOption" index="index" separator=" ">
				${searchOption.conjunction}
				${searchOption.columnName}
				<if test="searchOption.compareType lt 0">
				IN
					<foreach collection="searchOption.keywords" item="keyword" index="index" open="(" separator="," close=")">
						#{keyword}
					</foreach>
				</if>
				<if test="searchOption.compareType == 0">
					= #{searchOption.keyword}
				</if>
				<if test="searchOption.compareType gt 0">
					LIKE CONCAT('%', #{searchOption.keyword}, '%')
				</if>
			</foreach>
		</where>
		</if>
		</if>
		
		<!-- 정렬 -->
		<if test = "sortingOptions != null">
			<if test="sortingOptions.size gt 0">
			ORDER BY 
			<foreach collection="sortingOptions" item="sortingOption" separator=",">
				${sortingOption.columnName}
				<choose>
					<when test="sortingOption.ordering">
						DESC
					</when>
					<otherwise>
						ASC
					</otherwise>
				</choose> 
			</foreach>
			</if>
		</if>
		
		<!-- 페이징 -->
		<if test="pagingOption != null">
			<if test="pagingOption.size gt 0">
				LIMIT
				<if test="pagingOption.offset gt 0">
					#{pagingOption.offset},
				</if>
				#{pagingOption.size}
			</if>
		</if>	
	</select>
	
	<select id="getMusicSize" parameterType="Map" resultType="Integer">
		SELECT COUNT(*)
		FROM music_view
		<!-- 검색 -->
		<if test="searchOptions != null">
		<if test="searchOptions.size gt 0">
		<where>
			<foreach collection="searchOptions" item="searchOption" index="index" separator=" ">
				${searchOption.conjunction}
				${searchOption.columnName}
				<if test="searchOption.compareType lt 0">
				IN
					<foreach collection="searchOption.keywords" item="keyword" index="index" open="(" separator="," close=")">
						#{keyword}
					</foreach>
				</if>
				<if test="searchOption.compareType == 0">
					= #{searchOption.keyword}
				</if>
				<if test="searchOption.compareType gt 0">
					LIKE CONCAT('%', #{searchOption.keyword}, '%')
				</if>
			</foreach>
		</where>
		</if>
		</if>
	</select>
</mapper>